<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prova — Matemática e suas Tecnologias</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
  <style>
    input[name="studentName"] { text-transform: uppercase; }
    .no-select { user-select: none; -webkit-user-select: none; -ms-user-select: none; }
    .modal-backdrop { background: rgba(16,24,40,0.65); position: fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:60; }
    .modal { max-width:720px; width:94%; background:white; border-radius:12px; padding:24px; box-shadow:0 10px 30px rgba(2,6,23,0.2); }
    .toast { position: fixed; right: 20px; top: 20px; z-index:70; background: rgba(2,6,23,0.92); color: #fff; padding: 10px 14px; border-radius: 8px; box-shadow: 0 6px 18px rgba(2,6,23,0.3); display:flex; gap:10px; align-items:center; }
    .option-label { cursor:pointer; }
    input[type="radio"] { accent-color: #2563eb; }
    .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-left-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .check-wrap { width: 80px; height: 80px; background-color: #dcfce7; border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
    .check-svg { width: 48px; height: 48px; }
    .checkmark__path { stroke-dasharray: 100; stroke-dashoffset: 100; stroke: #22c55e; stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; fill: none; animation: draw 0.8s 0.2s ease-out forwards; }
    @keyframes draw { to { stroke-dashoffset: 0; } }
    .confetti { width:100%; height:40px; overflow:hidden; position:relative; }
    .confetti span{ position:absolute; top:-10px; font-size:12px; opacity:0; animation: conf 1400ms linear forwards; }
    .confetti span:nth-child(1){ left:10%; animation-delay:0ms; }
    .confetti span:nth-child(2){ left:30%; animation-delay:120ms; }
    .confetti span:nth-child(3){ left:50%; animation-delay:240ms; }
    .confetti span:nth-child(4){ left:70%; animation-delay:360ms; }
    @keyframes conf { to { transform: translateY(36px) rotate(25deg); opacity:1; } }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 no-select">
  <div class="max-w-5xl mx-auto p-6">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Bloco de Avaliação — Matemática e suas Tecnologias (3ª Série)</h1>
      <p class="text-sm text-gray-600 mt-1">Bem-vindo à Plataforma de Avaliação CEJA. 1 tentativa permitida.</p>
    </header>

    <section id="studentInfo" class="bg-white p-6 sm:p-8 rounded-xl shadow-md border border-slate-200/80 mb-6">
      <div class="mb-5 flex items-center gap-3"><div class="bg-blue-100 p-2 rounded-full"><svg class="w-6 h-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg></div><h2 class="text-xl font-bold text-slate-800">Identificação do Aluno</h2></div>
      <form id="infoForm" class="space-y-4">
        <div><label for="studentId" class="sr-only">Matrícula</label><div class="relative"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.5a.75.75 0 001.5 0v-8.5z" /><path d="M3.5 12a2.5 2.5 0 115 0 2.5 2.5 0 01-5 0zM11.5 12a2.5 2.5 0 115 0 2.5 2.5 0 01-5 0z" /><path fill-rule="evenodd" d="M5.057 14.42a.75.75 0 01.488.943 9.972 9.972 0 001.619 2.592.75.75 0 01-1.129.981 11.472 11.472 0 01-1.85-2.968.75.75 0 01.943-.488zM14.943 14.42a.75.75 0 00-.488.943 9.973 9.973 0 01-1.619 2.592.75.75 0 101.129.981 11.472 11.472 0 001.85-2.968.75.75 0 00-.943-.488z" clip-rule="evenodd" /></svg></div><input id="studentId" name="studentId" type="text" class="w-full rounded-lg border-gray-300 py-3 pl-10 pr-4 shadow-sm focus:border-blue-500 focus:ring-1" placeholder="Sua Matrícula (Ex: 2412767146-8)" required /></div></div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="studentName" class="sr-only">Nome Completo</label><div class="relative"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 00-13.074.003z" /></svg></div><input id="studentName" name="studentName" type="text" class="w-full rounded-lg border-gray-300 py-3 pl-10 pr-4 shadow-sm focus:border-blue-500 focus:ring-1" placeholder="Nome Completo (em caixa alta)" required /></div></div>
          <div><label for="studentClass" class="sr-only">Turma</label><div class="relative"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM6 6a.75.75 0 011.5 0v1.25a.75.75 0 01-1.5 0V6zM6 9.75a.75.75 0 011.5 0v3.5a.75.75 0 01-1.5 0v-3.5zM8.5 6a.75.75 0 011.5 0v3.5a.75.75 0 01-1.5 0V6zM12 6.75a.75.75 0 00-1.5 0V13a.75.75 0 001.5 0V6.75z" clip-rule="evenodd" /></svg></div><select id="studentClass" name="studentClass" class="w-full appearance-none rounded-lg border-gray-300 py-3 pl-10 pr-8 shadow-sm focus:border-blue-500 focus:ring-1" required><option value="" disabled selected>Selecione a Turma</option><option value="A">Turma A</option><option value="B">Turma B</option></select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700"><svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" /></svg></div></div></div></div>
        <p id="infoMsg" class="text-sm text-red-600 h-5"></p>
        <div class="pt-2"><button id="startBtn" type="button" class="group flex w-full items-center justify-center gap-2 rounded-lg bg-blue-600 px-6 py-3 font-semibold text-white transition hover:bg-blue-700 active:scale-95 disabled:bg-blue-400 disabled:cursor-wait"><span id="startBtnText">Iniciar Avaliação</span><div id="startBtnSpinner" class="spinner hidden"></div><svg class="h-5 w-5" id="startBtnArrow" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" /></svg></button></div>
      </form>
    </section>

    <main id="quizArea" class="hidden">
      <form id="quizForm" class="space-y-6 bg-white p-6 rounded shadow">


<!-- ============================================= -->
        <!--        INÍCIO DAS QUESTÕES (MATEMÁTICA 3ª SÉRIE) -->
        <!-- ============================================= -->

        <fieldset id="q1" class="border rounded p-4">
            <legend class="font-semibold">Item 1 - Matemática</legend>
            <p class="mt-2 text-sm">Considere o polinômio: P(x) = −4x³ + 3x² + 500x − 9</p>
            <p class="mt-2 text-sm font-semibold">O termo de maior grau e seu coeficiente são, respectivamente</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q1" value="A"><span>(A) 500x e 1</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q1" value="B"><span>(B) 500x e 500</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q1" value="C"><span>(C) 3x² e 2</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q1" value="D"><span>(D) -4x³ e 3</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q1" value="E"><span>(E) -4x³ e -4</span></label>
            </div>
        </fieldset>

        <fieldset id="q2" class="border rounded p-4">
            <legend class="font-semibold">Item 2 - Matemática</legend>
            <p class="mt-2 text-sm">Um remédio para dor é vendido em comprimidos e xarope, em que:<br>• Cada comprimido contém 500 mg do princípio ativo;<br>• Cada 10 ml de xarope contém 160 mg do princípio ativo.<br>Uma criança precisa consumir exatamente 1320 mg deste medicamento por dia. A mãe dessa criança decide administrar a medicação com um total de 4 unidades, entre comprimidos e doses de 10 ml de xarope.</p>
            <p class="mt-2 text-sm font-semibold">Quantos comprimidos e quantas doses de 10 ml de xarope devem ser dados à criança para atingir a dosagem correta?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q2" value="A"><span>(A) 0 comprimidos e 4 doses de xarope</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q2" value="B"><span>(B) 1 comprimido e 3 doses de xarope</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q2" value="C"><span>(C) 2 comprimidos e 2 doses de xarope</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q2" value="D"><span>(D) 3 comprimidos e 1 dose de xarope</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q2" value="E"><span>(E) 4 comprimidos e 0 doses de xarope</span></label>
            </div>
        </fieldset>
        
        <fieldset id="q3" class="border rounded p-4">
            <legend class="font-semibold">Item 3 - Matemática</legend>
            <p class="mt-2 text-sm">Com base na situação a seguir, resolva os itens 3 e 4.<br>Um agricultor está organizando o plantio em uma horta retangular com as medidas apresentadas na figura a seguir.</p>
            <div class="border-dashed" data-img-name="q3"></div>
            <p class="mt-2 text-sm font-semibold">Em função de x, qual expressão corresponde à área total da horta?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q3" value="A"><span>(A) A = 4x² – 9.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q3" value="B"><span>(B) A = 4x² + 9.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q3" value="C"><span>(C) A = 4x² - 6x – 9.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q3" value="D"><span>(D) A = 4x² - 6x + 9.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q3" value="E"><span>(E) A = 2x² – 9.</span></label>
            </div>
        </fieldset>
        
        <fieldset id="q4" class="border rounded p-4">
            <legend class="font-semibold">Item 4 - Matemática</legend>
            <p class="mt-2 text-sm">Igualando a expressão corresponde à área total da horta a 475 m².</p>
            <p class="mt-2 text-sm font-semibold">Qual será o valor de x para essa área?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q4" value="A"><span>(A) 9</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q4" value="B"><span>(B) 10</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q4" value="C"><span>(C) 11</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q4" value="D"><span>(D) 12</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q4" value="E"><span>(Ε) 13</span></label>
            </div>
        </fieldset>

        <fieldset id="q5" class="border rounded p-4">
            <legend class="font-semibold">Item 5 - Matemática</legend>
            <p class="mt-2 text-sm">Um nutricionista recomenda que uma pessoa consuma 60 g de proteína por dia, combinando ovos e leite. Sabe-se que:<br>• O paciente consome 9 unidades entre ovos e copos de leite, diariamente.<br>• Cada ovo contém 6 g de proteína.<br>• Cada copo de leite contém 8 g de proteína.</p>
            <p class="mt-2 text-sm font-semibold">Quantos ovos e copos de leite ele deve consumir por dia para atingir a quantidade exata de proteína recomendada?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q5" value="A"><span>(A) 5 ovos e 4 copos de leite.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q5" value="B"><span>(B) 6 ovos e 3 copos de leite.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q5" value="C"><span>(C) 7 ovos e 2 copos de leite.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q5" value="D"><span>(D) 8 ovos e 1 copo de leite.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q5" value="E"><span>(E) 9 ovos e 0 copos de leite.</span></label>
            </div>
        </fieldset>

        <fieldset id="q6" class="border rounded p-4">
            <legend class="font-semibold">Item 6 - Matemática</legend>
            <p class="mt-2 text-sm">(ENEM 2020 – PPL) O valor cobrado por uma corrida de táxi é calculado somando-se a bandeirada, um valor fixo que é cobrado em qualquer corrida, a um valor variável que depende da distância percorrida. Uma empresa de táxi cobra pela bandeirada o valor de R$ 4,50. Para corridas de até 200 metros, é cobrada somente a bandeirada, e para corridas superiores a 200 metros é cobrado o valor de R$ 0,02 para cada metro adicional percorrido. Para analisar o valor cobrado, em real, em função da distância percorrida, em metro, a empresa elaborou um gráfico, com uma simulação para uma distância de 600 metros.</p>
            <p class="mt-2 text-sm font-semibold">O gráfico que representa o valor da corrida, em real, em função da distância percorrida, em metro, é</p>
            <div class="border-dashed" data-img-name="q6"></div>
            <div class="mt-2 space-y-1 options">
                 <label class="flex items-center gap-2 option-label"><input required type="radio" name="q6" value="A"><span>(A) Gráfico A</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q6" value="B"><span>(B) Gráfico B</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q6" value="C"><span>(C) Gráfico C</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q6" value="D"><span>(D) Gráfico D</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q6" value="E"><span>(E) Gráfico E</span></label>
            </div>
        </fieldset>
        
        <fieldset id="q7" class="border rounded p-4">
            <legend class="font-semibold">Item 7 - Matemática</legend>
            <p class="mt-2 text-sm">Com base nas retas r e s, a seguir, resolva os itens 7 e 8.<br>Um sistema linear com duas equações tem como representação gráfica as retas r e s.</p>
            <div class="border-dashed" data-img-name="q7"></div>
            <p class="mt-2 text-sm font-semibold">Qual ponto corresponde à solução desse sistema?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q7" value="A"><span>(A) A.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q7" value="B"><span>(B) B.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q7" value="C"><span>(C) C.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q7" value="D"><span>(D) D.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q7" value="E"><span>(E) E.</span></label>
            </div>
        </fieldset>
        
        <fieldset id="q8" class="border rounded p-4">
            <legend class="font-semibold">Item 8 - Matemática</legend>
            <p class="mt-2 text-sm">Qual é a equação que representa a reta s?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q8" value="A"><span>(A) x + y = 6.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q8" value="B"><span>(B) x – y = 6.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q8" value="C"><span>(C) x – 2y = 0.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q8" value="D"><span>(D) x + y = 2.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q8" value="E"><span>(E) x – y = 2.</span></label>
            </div>
        </fieldset>
        
        <fieldset id="q9" class="border rounded p-4">
            <legend class="font-semibold">Item 9 - Matemática</legend>
            <p class="mt-2 text-sm">Com base na figura a seguir, resolva os itens 9 e 10.</p>
            <div class="border-dashed" data-img-name="q9"></div>
            <p class="mt-2 text-sm font-semibold">Qual expressão algébrica representa o perímetro da figura?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q9" value="A"><span>(A) 9x + 3y.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q9" value="B"><span>(B) 9x + 4y.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q9" value="C"><span>(C) 12x + y.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q9" value="D"><span>(D) 12x + 4y.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q9" value="E"><span>(E) 15x + 5y.</span></label>
            </div>
        </fieldset>
        
        <fieldset id="q10" class="border rounded p-4">
            <legend class="font-semibold">Item 10 - Matemática</legend>
            <p class="mt-2 text-sm font-semibold">Qual expressão algébrica representa a área da figura?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q10" value="A"><span>(A) 9x² + 6xy + y².</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q10" value="B"><span>(B) 9x² + 3xy + y².</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q10" value="C"><span>(C) 9x² + y².</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q10" value="D"><span>(D) 9xy + y².</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q10" value="E"><span>(E) 3xy + 9y².</span></label>
            </div>
        </fieldset>
        
        <fieldset id="q11" class="border rounded p-4">
            <legend class="font-semibold">Item 11 - Matemática</legend>
            <p class="mt-2 text-sm">Uma escola arrecadou, em um bazar, um total de R$ 1200,00 com a venda de camisetas e bonés. Sabendo que foram vendidas 70 unidades no total, entre camisetas e bonés, e que cada camiseta foi vendida por R$ 20,00 e cada boné por R$ 10,00.</p>
            <p class="mt-2 text-sm font-semibold">Qual foi a quantia arrecadada, em reais, pela venda das camisetas?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q11" value="A"><span>(A) 100</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q11" value="B"><span>(B) 200</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q11" value="C"><span>(C) 800</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q11" value="D"><span>(D) 1000</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q11" value="E"><span>(E) 1100</span></label>
            </div>
        </fieldset>
        
        <fieldset id="q12" class="border rounded p-4">
            <legend class="font-semibold">Item 12 - Matemática</legend>
            <p class="mt-2 text-sm">Com base na situação, a seguir, resolva os itens 12 e 13. Um professor de ciências comprou uma caixa em forma de paralelepípedo com as dimensões, em decímetros, a seguir.</p>
            <div class="border-dashed" data-img-name="q12"></div>
            <p class="mt-2 text-sm font-semibold">Qual polinômio, na forma reduzida, que representa o volume dessa caixa?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q12" value="A"><span>(A) 6x + 3,5.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q12" value="B"><span>(B) 24x + 14.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q12" value="C"><span>(C) 8x² + 4x.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q12" value="D"><span>(D) 20x² + 10.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q12" value="E"><span>(E) 20x² + 10x.</span></label>
            </div>
        </fieldset>
        
        <fieldset id="q13" class="border rounded p-4">
            <legend class="font-semibold">Item 13 - Matemática</legend>
            <p class="mt-2 text-sm">Considerando que a capacidade da caixa é de 60 litros.</p>
            <p class="mt-2 text-sm font-semibold">Qual o valor de x para essa capacidade?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q13" value="A"><span>(A) 0,5.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q13" value="B"><span>(B) 1,0.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q13" value="C"><span>(C) 1,5.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q13" value="D"><span>(D) 2,0.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q13" value="E"><span>(Ε) 2,5.</span></label>
            </div>
        </fieldset>

        <fieldset id="q14" class="border rounded p-4">
            <legend class="font-semibold">Item 14 - Matemática</legend>
            <p class="mt-2 text-sm">Observe o polinômio a seguir: 14x⁴ + 5x³y² – 10x²y² – 30xy³ + xy – 15. Considere as seguintes afirmações:<br>I- A parte literal do termo de maior grau é x³y².<br>II – O grau do termo xy é igual a 1.<br>III – O coeficiente do termo –10x²y² é igual a −10.<br>IV – O polinômio possui 5 termos.</p>
            <p class="mt-2 text-sm font-semibold">As afirmações verdadeiras são:</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q14" value="A"><span>(A) I e III.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q14" value="B"><span>(B) II e III.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q14" value="C"><span>(C) I, II e III.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q14" value="D"><span>(D) II, III e IV.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q14" value="E"><span>(E) I, II, III e IV.</span></label>
            </div>
        </fieldset>
        
        <fieldset id="q15" class="border rounded p-4">
            <legend class="font-semibold">Item 15 - Matemática</legend>
            <p class="mt-2 text-sm">Fernanda possui 2 cachorros, um Dálmata e um Cocker Spaniel, e está tentando controlar os seus gastos mensais com os seus bichinhos. Ela deseja gastar no máximo R$ 450,00 por mês com ração para seus cães.<br>• Ela compra entre 2 marcas de ração a granel, sendo que a marca A custa R$ 15,00 por quilo e a marca B custa R$ 20,00 por quilo.<br>• Seus cães devem consumir exatamente 25 kg de ração por mês, variando entre duas marcas de ração.</p>
            <p class="mt-2 text-sm font-semibold">Quanto Fernanda deve comprar de cada marca de ração para atender a sua demanda?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q15" value="A"><span>(A) 20 kg da marca A e 5 kg da marca B.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q15" value="B"><span>(B) 15 kg da marca A e 10 kg da marca B.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q15" value="C"><span>(C) 12,5 kg da marca A e 12,5 kg da marca B.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q15" value="D"><span>(D) 10 kg da marca A e 15 kg da marca B.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q15" value="E"><span>(E) 5 kg da marca A e 20 kg da marca B.</span></label>
            </div>
        </fieldset>

        <fieldset id="q16" class="border rounded p-4">
            <legend class="font-semibold">Item 16 - Matemática</legend>
            <p class="mt-2 text-sm">Segundo dados do Instituto Nacional de Meteorologia (INMET), o uso de aparelhos de climatização tende a aumentar durante ondas de calor. Um empresário tem em seu escritório dois modelos de ar-condicionado.<br>• O modelo A consome 1,2 kWh por hora.<br>• O modelo B consome 0,8 kWh por hora.<br>Sabe-se que, em determinado dia de trabalho, os dois aparelhos ficaram ligados por um total de 10 horas combinadas, e o consumo foi de 10,4 kWh.</p>
            <p class="mt-2 text-sm font-semibold">Quantas horas cada aparelho ficou ligado?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q16" value="A"><span>(A) 7h o modelo A e 3h o modelo B</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q16" value="B"><span>(B) 6h o modelo A e 4h o modelo B</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q16" value="C"><span>(C) 5h o modelo A e 5h o modelo B</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q16" value="D"><span>(D) 4h o modelo A e 6h o modelo B</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q16" value="E"><span>(E) 3h o modelo A e 7h o modelo B</span></label>
            </div>
        </fieldset>
        
        <fieldset id="q17" class="border rounded p-4">
            <legend class="font-semibold">Item 17 - Matemática</legend>
            <p class="mt-2 text-sm">(ENEM 2015) Após realizar uma pesquisa de mercado, uma operadora de telefonia celular ofereceu aos clientes que utilizavam até 500 ligações ao mês o seguinte plano mensal: um valor fixo de R$ 12,00 para os clientes que fazem até 100 ligações ao mês. Caso o cliente faça mais de 100 ligações, será cobrado um valor adicional de R$ 0,10 por ligação, a partir da 101ª até a 300ª; e caso realize entre 300 e 500 ligações, será cobrado um valor fixo mensal de R$ 32,00.</p>
            <p class="mt-2 text-sm font-semibold">Com base nos elementos apresentados, o gráfico que melhor representa a relação entre o valor mensal pago nesse plano e o número de ligações feitas é:</p>
            <div class="border-dashed" data-img-name="q17"></div>
             <div class="mt-2 space-y-1 options">
                 <label class="flex items-center gap-2 option-label"><input required type="radio" name="q17" value="A"><span>(A) Gráfico A</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q17" value="B"><span>(B) Gráfico B</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q17" value="C"><span>(C) Gráfico C</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q17" value="D"><span>(D) Gráfico D</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q17" value="E"><span>(E) Gráfico E</span></label>
            </div>
        </fieldset>
        
        <fieldset id="q18" class="border rounded p-4">
            <legend class="font-semibold">Item 18 - Matemática</legend>
            <p class="mt-2 text-sm">Uma costureira produz dois tipos de camisetas: manga longa (x) e regata (y). A produção diária é limitada por duas condições:<br>• Cada camiseta manga longa leva 1 hora de trabalho para ser feita, e cada camiseta regata, 2 horas. O total de horas de trabalho diário é de 15 horas.<br>• Cada camiseta manga longa usa 2 metros de tecido, e cada camiseta regata usa 1 metro. O máximo de tecido utilizado por dia é de 12 metros.</p>
            <p class="mt-2 text-sm font-semibold">Qual sistema representa corretamente essa situação?</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q18" value="A"><span>(A) { x + 2y = 15; 2x + y = 12</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q18" value="B"><span>(B) { x + y = 15; 2x + y = 12</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q18" value="C"><span>(C) { x + y = 12; 2x + y = 15</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q18" value="D"><span>(D) { x + 2y = 12; 2x + y = 15</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q18" value="E"><span>(E) { 2x + y = 15; x + 2y = 12</span></label>
            </div>
        </fieldset>

        <fieldset id="q19" class="border rounded p-4">
            <legend class="font-semibold">Item 19 - Matemática</legend>
            <p class="mt-2 text-sm">Observe o gráfico a seguir.</p>
            <div class="border-dashed" data-img-name="q19"></div>
            <p class="mt-2 text-sm font-semibold">A lei de formação dessa função é:</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q19" value="A"><span>(A) f(x) = -2x + 6</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q19" value="B"><span>(B) f(x) = -3x + 3</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q19" value="C"><span>(C) f(x) = -3x + 6</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q19" value="D"><span>(D) f(x) = 3x + 6</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q19" value="E"><span>(E) f(x) = -3x - 6</span></label>
            </div>
        </fieldset>
        
        <fieldset id="q20" class="border rounded p-4">
            <legend class="font-semibold">Item 20 - Matemática</legend>
            <p class="mt-2 text-sm">(IFG 2019 – Adaptada) Considere a soma das medidas de uma base e da altura relativa a essa base de um triângulo igual a 168 cm, e a diferença igual a 24 cm.</p>
            <p class="mt-2 text-sm font-semibold">É correto afirmar que as medidas da base e da altura relativa a essa base medem, respectivamente</p>
            <div class="mt-2 space-y-1 options">
                <label class="flex items-center gap-2 option-label"><input required type="radio" name="q20" value="A"><span>(A) 72 cm e 96 cm.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q20" value="B"><span>(B) 144 cm e 24 cm.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q20" value="C"><span>(C) 84 cm e 84 cm.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q20" value="D"><span>(D) 24 cm e 144 cm.</span></label>
                <label class="flex items-center gap-2 option-label"><input type="radio" name="q20" value="E"><span>(E) 96 cm e 72 cm.</span></label>
            </div>
        </fieldset>

        <!-- Fim das Questões -->
        
        <div class="flex items-center justify-between"><div class="text-sm text-gray-600"></div><button id="submitBtn" type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Enviar prova</button></div>
      </form>
    </main>

    <footer class="mt-6 text-xs text-gray-500 text-center">COLÉGIO ESTADUAL JOSÉ ABÍLIO: 2025@</footer>
    </div>
    <div id="modalRoot" style="display:none;"></div>

<script>
    const SERIES = "3_SERIE_MATEMATICA"; 
    const MAX_ATTEMPTS = 1;
    const PROGRESS_KEY = `progress_${SERIES}`;
    const SUPABASE_URL = "https://ggqljtbbjavvyvawiwus.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdncWxqdGJiamF2dnl2YXdpd3VzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNzY0MTgsImV4cCI6MjA3MzY1MjQxOH0.PnMwg10Hu_02lytY91JkfyqlDtAUdB_LpgQLOAJKi04";
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const studentNameInput = document.getElementById('studentName');
    const studentIdInput = document.getElementById('studentId');
    const studentClassInput = document.getElementById('studentClass');
    const startBtn = document.getElementById('startBtn');
    const startBtnText = document.getElementById('startBtnText');
    const startBtnSpinner = document.getElementById('startBtnSpinner');
    const startBtnArrow = document.getElementById('startBtnArrow');
    const infoMsg = document.getElementById('infoMsg');
    const quizArea = document.getElementById('quizArea');
    const quizForm = document.getElementById('quizForm');
    const modalRoot = document.getElementById('modalRoot');

    async function signInAnonymously() {
        const { error } = await supabaseClient.auth.signInAnonymously();
        if (error) {
            console.error('Erro ao fazer login anônimo:', error);
            document.body.innerHTML = '<div style="text-align: center; padding: 50px; font-family: sans-serif;"><h1>Erro de Conexão</h1><p>Não foi possível iniciar uma sessão segura. Por favor, recarregue a página.</p></div>';
            throw new Error("Falha na sessão anônima.");
        }
    }
    
    function qs(sel, ctx = document) { return ctx.querySelector(sel); }
    function qsa(sel, ctx = document) { return Array.from(ctx.querySelectorAll(sel)); }
    
    function normalizeString(str) {
      if (!str) return '';
      let normalized = str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      return normalized.toUpperCase().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
    }
    
    studentNameInput.addEventListener('input', () => studentNameInput.value = studentNameInput.value.toUpperCase());
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => { if ((e.ctrlKey && e.key === 'r') || e.key === 'F5' || (e.ctrlKey && e.shiftKey && (e.key === 'i' || e.key === 'I')) || e.key === 'F12') e.preventDefault(); });

    startBtn.addEventListener('click', async () => {
        infoMsg.textContent = '';
        const name = studentNameInput.value.trim();
        const matricula = studentIdInput.value.trim();
        const turma = studentClassInput.value;
        if (!matricula || !name || !turma) { infoMsg.textContent = 'Todos os campos são obrigatórios.'; return; }
        
        startBtn.disabled = true; startBtnText.textContent = 'Verificando...'; startBtnSpinner.classList.remove('hidden'); startBtnArrow.classList.add('hidden');
        try {
            const { data: aluno, error } = await supabaseClient.from('alunos').select('nome_completo').eq('matricula', matricula).single();
            if (error || !aluno) throw new Error("Matrícula não encontrada. Verifique os dados.");
            if (normalizeString(aluno.nome_completo) !== normalizeString(name.replace(/_/g, ' '))) throw new Error("O nome não corresponde à matrícula informada.");

            const key = `exam_${SERIES}_${matricula}`;
            let record = JSON.parse(localStorage.getItem(key));
            if (record && record.attempts >= MAX_ATTEMPTS) throw new Error(`Você já atingiu o limite de ${MAX_ATTEMPTS} tentativa(s).`);

            if (!record) { record = { name: name.toUpperCase(), matricula, turma, attempts: 0, history: [], wrongQuestions: [] }; }
            else { record.name = name.toUpperCase(); record.turma = turma; }
            localStorage.setItem(key, JSON.stringify(record));

            qs('#studentInfo').classList.add('hidden');
            quizArea.classList.remove('hidden');
            if (record.attempts > 0 && Array.isArray(record.wrongQuestions)) {
                prepareSecondAttemptView(matricula, record.wrongQuestions);
            }
        } catch (err) {
            infoMsg.textContent = err.message; console.error("Falha na validação do aluno:", err.message);
        } finally {
            startBtn.disabled = false; startBtnText.textContent = 'Iniciar Avaliação'; startBtnSpinner.classList.add('hidden'); startBtnArrow.classList.remove('hidden');
        }
    });
    
    if (quizForm) quizForm.addEventListener('submit', async function (ev) {
        ev.preventDefault();
        const matricula = studentIdInput.value.trim();
        const key = `exam_${SERIES}_${matricula}`;
        let record = JSON.parse(localStorage.getItem(key));
        if (!record) { alert('Erro: registro do aluno não encontrado.'); return; }

        const studentAnswers = {};
        const visibleFieldsets = qsa('fieldset[id^="q"]', quizForm).filter(fs => fs.style.display !== 'none');
        let allAnswered = true;
        visibleFieldsets.forEach(fs => { const sel = qs(`input[name="${fs.id}"]:checked`, fs); if (!sel) allAnswered = false; studentAnswers[fs.id] = sel ? sel.value : null; });
        if (!allAnswered) { showToast('Responda todas as questões antes de enviar.', 'warn'); return; }

        qs('#submitBtn').disabled = true; qs('#submitBtn').textContent = 'Corrigindo...';
        
        try {
            const invokeCorrection = async (answers) => {
                const { data, error } = await supabaseClient.rpc('corrigir_respostas_aluno', { exam_id: SERIES, student_answers: answers });
                if (error) throw new Error(`Erro na API de correção: ${error.message}`);
                if (data.error) throw new Error(`Erro no servidor: ${data.error}`);
                return data;
            };

            record.attempts++;
            record.history = record.history || [];
            record.history.push({ attempt: record.attempts, answers: studentAnswers, ts: new Date().toISOString() });
            
            const isSecondAttempt = record.attempts > 1;
            const answersToCorrect = isSecondAttempt ? { ...(record.history[0]?.answers || {}), ...studentAnswers } : studentAnswers;
            const resultData = await invokeCorrection(answersToCorrect);

            record.correctCount = resultData.correctCount;
            record.totalQuestions = resultData.totalQuestions;
            if (record.attempts === 1) {
                record.wrongQuestions = resultData.wrongQuestions;
                record.retakeAllowed = resultData.wrongQuestions.length > 0 && MAX_ATTEMPTS > 1;
            }
            if (record.attempts >= MAX_ATTEMPTS || !record.retakeAllowed) { record.finalized = true; record.finalAnswers = answersToCorrect; }
            
            localStorage.setItem(key, JSON.stringify(record));
            localStorage.removeItem(PROGRESS_KEY);
            quizArea.classList.add('hidden');
            if (record.finalized) { showModalResultFinal(record); } else { showModalResultPartial(record); }
        } catch (err) {
            console.error("Erro ao chamar a função de correção:", err.message);
            showToast('Houve um erro ao corrigir sua prova. Tente novamente.', 'error');
            if (record) { record.attempts--; localStorage.setItem(key, JSON.stringify(record)); }
        } finally { qs('#submitBtn').disabled = false; qs('#submitBtn').textContent = 'Enviar prova'; }
    });
    
    function animateValue(element, start, end, duration) { let startTimestamp = null; const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); const easedProgress = 1 - Math.pow(1 - progress, 3); element.textContent = Math.floor(easedProgress * (end - start) + start); if (progress < 1) { window.requestAnimationFrame(step); } else { element.textContent = end; } }; window.requestAnimationFrame(step); }
    function createModal(htmlContent) { modalRoot.innerHTML = `<div class="modal-backdrop"><div class="modal">${htmlContent}</div></div>`; modalRoot.style.display = 'flex'; qs('.modal-backdrop', modalRoot).addEventListener('click', e => { if (e.target === e.currentTarget) { const record = JSON.parse(localStorage.getItem(`exam_${SERIES}_${studentIdInput.value.trim()}`)); if (!record || record.finalized || !record.retakeAllowed) closeModal(); } }); }
    function closeModal() { modalRoot.style.display = 'none'; modalRoot.innerHTML = ''; }
    function showToast(text, type = 'info') { const t = document.createElement('div'); t.className = 'toast'; t.textContent = text; document.body.appendChild(t); setTimeout(() => { t.style.transition = 'opacity 400ms'; t.style.opacity = '0'; }, 2600); setTimeout(() => t.remove(), 3000); }
    function showModalResultPartial(record) { const total = record.totalQuestions || 20; const pct = Math.round((record.correctCount / total) * 100); const msg = `Você pode refazer apenas as ${record.wrongQuestions.length} questões que errou. Boa sorte!`; const btn = `<button id="modalRetake" class="group flex w-full sm:w-auto items-center justify-center gap-2 rounded-lg bg-blue-600 px-5 py-3 font-semibold text-white transition hover:bg-blue-700 active:scale-95"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201-4.42 5.5 5.5 0 017.48-5.013.563.563 0 01.764.819l-1.22 1.464a.563.563 0 01-.764-.819A4.375 4.375 0 006.19 7.004a4.375 4.375 0 007.412 3.56a.563.563 0 01.81.76zM4.688 8.576a5.5 5.5 0 019.201 4.42 5.5 5.5 0 01-7.48 5.013.563.563 0 01-.764-.819l1.22-1.464a.563.563 0 01.764.819 4.375 4.375 0 007.92-3.56 4.375 4.375 0 00-7.412-3.56.563.563 0 01-.81-.76z" clip-rule="evenodd" /></svg><span>Fazer 2ª Tentativa</span></button>`; createModal(`<div class="text-center"><div class="check-wrap"><svg class="check-svg" viewBox="0 0 52 52"><path class="checkmark__path" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg></div><h2 class="text-2xl font-bold text-slate-900 mt-4">1ª Tentativa Concluída</h2><p class="text-5xl font-bold text-slate-800 my-2"><span id="score-counter">0</span>%</p><p class="text-sm text-gray-600">Acertos: ${record.correctCount} de ${total}</p><p class="mt-4 max-w-md mx-auto">${msg}</p><div id="confetti-container" class="confetti"></div><div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">${btn}</div></div>`); const scoreEl = qs('#score-counter'); setTimeout(() => { animateValue(scoreEl, 0, pct, 1500); setTimeout(() => { qs('#confetti-container').innerHTML = `<span>🎉</span><span>🎊</span><span>🥳</span><span>✨</span>`; }, 1500); }, 300); qs('#modalRetake')?.addEventListener('click', () => { closeModal(); quizArea.classList.remove('hidden'); prepareSecondAttemptView(record.matricula, record.wrongQuestions); }); }
    function showModalResultFinal(record) { const total = record.totalQuestions || 20; const pct = Math.round((record.correctCount / total) * 100); const msg = "Desempenho finalizado. Clique abaixo para gerar e enviar seu resultado."; const btn = `<button id="modalExport" class="group flex w-full sm:w-auto items-center justify-center gap-2 rounded-lg bg-indigo-600 px-5 py-3 font-semibold text-white transition hover:bg-indigo-700 active:scale-95"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.5a.75.75 0 001.5 0v-8.5z" /><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v4.59L7.3 9.24a.75.75 0 00-1.1 1.02l3.25 3.5a.75.75 0 001.1 0l3.25-3.5a.75.75 0 10-1.1-1.02l-1.95 2.1V6.75z" clip-rule="evenodd" /></svg><span>Enviar Resultado Final</span></button>`; createModal(`<div class="text-center"><div class="check-wrap"><svg class="check-svg" viewBox="0 0 52 52"><path class="checkmark__path" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg></div><h2 class="text-2xl font-bold text-slate-900 mt-4">Avaliação Finalizada!</h2><p class="text-5xl font-bold text-slate-800 my-2"><span id="score-counter">0</span>%</p><p class="text-sm text-gray-600">Acertos: ${record.correctCount} de ${total}</p><p class="mt-4 max-w-md mx-auto">${msg}</p><div id="confetti-container" class="confetti"></div><div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">${btn}</div></div>`); const scoreEl = qs('#score-counter'); setTimeout(() => { animateValue(scoreEl, 0, pct, 1500); setTimeout(() => { qs('#confetti-container').innerHTML = `<span>🎉</span><span>🎊</span><span>🥳</span><span>✨</span>`; }, 1500); }, 300); qs('#modalExport')?.addEventListener('click', () => triggerExport(record.matricula)); }
    
    function saveProgress() { if (quizArea.classList.contains('hidden')) return; const matricula = studentIdInput.value.trim(); if (!matricula) return; const formData = new FormData(quizForm); const currentAnswers = {}; for (let [key, value] of formData.entries()) { currentAnswers[key] = value; } localStorage.setItem(PROGRESS_KEY, JSON.stringify({ matricula, answers: currentAnswers })); }
    function restoreProgress() { const savedProgress = localStorage.getItem(PROGRESS_KEY); if (!savedProgress) return; const progress = JSON.parse(savedProgress); if (!progress?.matricula) return; const key = `exam_${SERIES}_${progress.matricula}`; const record = JSON.parse(localStorage.getItem(key)); if (record && !record.finalized) { studentIdInput.value = record.matricula; studentNameInput.value = record.name; studentClassInput.value = record.turma; qs('#studentInfo').classList.add('hidden'); quizArea.classList.remove('hidden'); showToast('Seu progresso foi restaurado.', 'info'); Object.entries(progress.answers).forEach(([q, a]) => { const radio = qs(`input[name="${q}"][value="${a}"]`); if (radio) radio.checked = true; }); if (record.attempts > 0 && Array.isArray(record.wrongQuestions)) { prepareSecondAttemptView(record.matricula, record.wrongQuestions, false); } } else { localStorage.removeItem(PROGRESS_KEY); } }
    function prepareSecondAttemptView(matricula, wrongQuestions, shouldShuffle = true) { qsa('fieldset[id^="q"]', quizForm).forEach(fs => { const qnum = parseInt(fs.id.replace('q', '')); if (wrongQuestions.includes(qnum)) { fs.style.display = ''; fs.querySelectorAll('input[type="radio"]').forEach(r => { r.checked = false; r.required = true; }); if (shouldShuffle) shuffleOptions(fs); } else { fs.style.display = 'none'; fs.querySelectorAll('input[type="radio"]').forEach(r => r.required = false); } }); if (shouldShuffle) showToast('Responda apenas as questões que você errou.', 'info'); }
    function shuffleOptions(fieldset) { const container = fieldset.querySelector('.options'); if (container) for (let i = container.children.length; i >= 0; i--) container.appendChild(container.children[Math.random() * i | 0]); }
    
    function triggerExport(matricula) {
        const key = `exam_${SERIES}_${matricula}`;
        const record = JSON.parse(localStorage.getItem(key));
        if (!record?.finalized) { showToast('A prova precisa ser finalizada.', 'warn'); return; }

        const btn = qs('#modalExport');
        if (btn) { btn.disabled = true; btn.innerHTML = '<div class="spinner"></div>Gerando PDF...'; }

        supabaseClient
            .from('gabaritos')
            .select('gabarito_completo')
            .eq('serie', SERIES)
            .single()
        .then(({ data, error }) => {
            if (error || !data) {
                throw new Error(error?.message || 'Gabarito não encontrado para a geração do PDF.');
            }
            const GABARITO_PDF = data.gabarito_completo || {};
            const totalQuestions = Object.keys(GABARITO_PDF).length || 20;
            const answers = record.finalAnswers || {};

            const tableBody = [...Array(totalQuestions).keys()].map(i => {
                const qKey = `q${i + 1}`;
                const isCorrect = answers[qKey] === GABARITO_PDF[qKey];
                return `<tr style="background-color:${isCorrect ? '#f0fff4' : '#fff5f5'};">
                    <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">${i + 1}</td>
                    <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">${GABARITO_PDF[qKey] || '-'}</td>
                    <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">${answers[qKey] || 'N/R'}</td>
                    <td style="padding: 8px; text-align: center; color:${isCorrect ? '#16a34a' : '#dc2626'}; font-weight: bold;">${isCorrect ? '✓' : '✗'}</td>
                </tr>`;
            }).join('');
            
            const dataHora = new Date(record.gradedAt || Date.now()).toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            const safeName = normalizeString(record.name);
            const filePath = `${SERIES}/TURMA_${record.turma}/${record.matricula}-${safeName}.pdf`;
            const wrapper = document.createElement('div');
            wrapper.innerHTML = `<div style="font-family: Arial, sans-serif; padding: 40px; font-size: 12px; color: #333;"><div style="text-align: center; margin-bottom: 20px;"><h2 style="font-size: 24px; margin: 0; color: #111;">Resultado Final da Avaliação</h2><p style="font-size: 16px; color: #555;">Matemática e suas Tecnologias</p></div><div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px; background-color: #f8f9fa;"><p style="margin: 4px 0;"><strong>Aluno:</strong> ${record.name}</p><p style="margin: 4px 0;"><strong>Matrícula:</strong> ${record.matricula}</p><p style="margin: 4px 0;"><strong>Turma:</strong> ${record.turma}</p><p style="margin: 4px 0;"><strong>Data de Finalização:</strong> ${dataHora}</p></div><div style="margin-bottom: 20px;"><p style="font-size: 16px;"><strong>Pontuação Final:</strong> ${record.correctCount} de ${totalQuestions} acertos (${Math.round((record.correctCount / totalQuestions) * 100)}%)</p></div><table style="width: 100%; border-collapse: collapse; font-size: 11px;"><thead><tr style="background-color:#e9ecef;"><th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Questão</th><th style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">Gabarito</th><th style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">Sua Resposta</th><th style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">Status</th></tr></thead><tbody>${tableBody}</tbody></table><p style="margin-top: 30px; font-size: 10px; color: #999; text-align: center;">Documento gerado pelo Portal de Avaliações CEJA</p></div>`;
            const opt = { margin: 0.5, filename: `${safeName}.pdf`, jsPDF: { unit: 'in', format: 'a4' }, html2canvas: { scale: 2 } };

            html2pdf().set(opt).from(wrapper).output('blob').then(pdfBlob => {
                supabaseClient.storage.from('resultados-provas').upload(filePath, pdfBlob, { upsert: true })
                .then(({ error: uploadError }) => {
                    if (uploadError) throw uploadError;
                    showToast('Prova enviada com sucesso!', 'success');
                    if (btn) btn.textContent = "Enviado!";
                    localStorage.removeItem(key);
                })
                .catch(err => {
                    console.error('Erro no envio para Supabase:', err);
                    showToast('Erro ao enviar. Baixando PDF localmente.', 'error');
                    if (btn) { btn.disabled = false; btn.innerHTML = '<span>Tentar de Novo</span>'; }
                    saveAs(pdfBlob, `${record.matricula}-${safeName}.pdf`);
                });
            });
        }).catch(err => {
             console.error("Erro ao buscar gabarito para PDF:", err.message);
             showToast('Erro crítico ao preparar PDF.', 'error');
             if(btn) { btn.disabled = false; btn.innerHTML = '<span>Enviar Resultado Final</span>'; }
        });
    }

    function insertImagesAuto(folder = '../assets/imgmat3') { 
      const placeholders = qsa('div.border-dashed');
      if (!placeholders.length) return;
      function tryLoad(candidates) { return new Promise((resolve,reject) => {let i=0; const next=()=>{if(i>=candidates.length)return reject(); const url=candidates[i++]; const img=new Image(); img.onload=()=>resolve(url); img.onerror=next; img.src=url;}; next();});}
      placeholders.forEach((ph) => {
        const fs=ph.closest('fieldset'); if(!fs)return;
        const qid=fs.id.replace('q','');
        const exts=['webp','jpg','jpeg','png','gif'];
        const candidates = exts.map(ext=>`${folder}/q${qid}.${ext}`);
        tryLoad(candidates).then(src => { ph.innerHTML = `<img src="${src}" alt="Imagem da questão ${qid}" class="mx-auto max-w-full h-auto rounded shadow clickable-img" loading="lazy">`; }).catch(() => { ph.innerHTML = `<p class="text-xs text-gray-500">Imagem da questão indisponível.</p>` });
      });
      if (!qs('#lb')) { const lb=document.createElement('div'); lb.id='lb'; lb.style.cssText='position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);z-index:9999;padding:20px;cursor:zoom-out;'; lb.innerHTML = '<img id="lb-img" style="max-width:95%;max-height:95%;border-radius:6px;"/>'; document.body.appendChild(lb); lb.addEventListener('click', ()=>{lb.style.display='none'; qs('#lb-img').src='';});}
      document.addEventListener('click', function(e) { if (e.target?.classList.contains('clickable-img')) { qs('#lb-img').src=e.target.src; qs('#lb').style.display='flex'; } });
    }

    window.addEventListener('load', async () => { await signInAnonymously(); restoreProgress(); if(quizForm)quizForm.addEventListener('change', saveProgress); insertImagesAuto(); });
</script>
</body>
</html>