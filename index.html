<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Portal de Avalia√ß√µes ‚Äî Col√©gio Estadual Jos√© Ab√≠lio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes progressBarFill { from { width: 0%; } to { width: 100%; } }
        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @property --gradient-angle { syntax: '<angle>'; inherits: false; initial-value: 0deg; }
        @keyframes gradient-rotation { to { --gradient-angle: 360deg; } }

        body { background-color: #f1f5f9; }
        .page-container { animation: fadeIn 600ms ease-out; }
        #page-loader, .modal-backdrop { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); animation: fadeInOverlay 300ms ease-out; }
        .loader-bar { animation: progressBarFill 1.5s ease-out forwards; }
        #admin-login-modal-content, #admin-area-content { animation: fadeIn 500ms ease-out forwards; }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.1); border-left-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        .tab-content { animation: fadeIn 400ms ease-out; }
        
        .exam-card-wrapper { position: relative; }
        .exam-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; z-index: 1; }
        .exam-card-wrapper::before { content: ''; position: absolute; inset: -2px; z-index: 0; border-radius: 1.1rem; background: conic-gradient(from var(--gradient-angle), #a78bfa, #3b82f6, #6ee7b7, #a78bfa); opacity: 0; transition: opacity 0.4s ease-out; animation: gradient-rotation 4s linear infinite; }
        .exam-card-wrapper.available:hover::before { opacity: 1; }

        #admin-area-content { transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .admin-area-open #admin-area-content { transform: translateX(0); }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased">
    <!-- MODAL DE LOGIN DO PROFESSOR -->
    <div id="admin-login-modal" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div id="admin-login-modal-content" class="bg-white relative rounded-xl shadow-2xl p-8 w-full max-w-sm">
            <button id="admin-login-close-btn" class="absolute top-2 right-2 p-2 text-slate-400 hover:text-slate-600 transition"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            <h3 class="text-lg font-bold text-slate-800 text-center">√Årea do Professor</h3>
            <p class="text-sm text-slate-500 text-center mt-2">Fa√ßa login para gerenciar as avalia√ß√µes.</p>
            <div class="space-y-4 mt-6">
                <input type="email" id="email-input" class="w-full rounded-lg border-gray-300 py-3 px-4 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="seu-email@dominio.com">
                <input type="password" id="password-input" class="w-full rounded-lg border-gray-300 py-3 px-4 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <button id="login-submit-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                    <span id="login-btn-text">Entrar</span>
                    <div id="login-spinner" class="spinner hidden" style="width: 20px; height: 20px; border-left-color: #fff;"></div>
                </button>
            </div>
            <p id="login-error" class="text-xs text-red-500 mt-2 h-4 text-center"></p>
        </div>
    </div>
    
    <!-- LOADER DE TRANSI√á√ÉO -->
    <div id="page-loader" class="hidden fixed inset-0 bg-white/80 z-[60] flex items-center justify-center">
        <div class="w-full max-w-sm text-center"><div class="text-lg font-semibold text-slate-700 mb-3">Carregando avalia√ß√£o...</div><div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden"><div class="loader-bar bg-blue-600 h-2 rounded-full"></div></div></div>
    </div>
    
    <div class="page-container relative z-10 p-4 sm:p-6 min-h-screen flex flex-col">
        <main class="w-full max-w-5xl mx-auto flex-grow">
            <header class="text-center my-12">
                <h1 class="text-4xl font-bold tracking-tight text-slate-900">Portal de Avalia√ß√µes 2025</h1>
                <p class="text-lg text-slate-600 mt-2">Selecione uma avalia√ß√£o para iniciar.</p>
            </header>

            <div id="loading-exams" class="flex flex-col items-center justify-center p-12">
                <div class="spinner"></div>
                <p class="mt-4 text-slate-500">Carregando agendamento de provas...</p>
            </div>
            
            <div id="exam-portal" class="hidden w-full mx-auto">
                <div class="border-b border-gray-200 mb-8">
                    <nav id="tabs" class="-mb-px flex space-x-6 sm:space-x-8 overflow-x-auto" aria-label="Tabs"></nav>
                </div>
                <div id="tab-container" class="mt-8"></div>
            </div>
        </main>
        
        <footer class="mt-16 text-xs text-gray-500 text-center">COL√âGIO ESTADUAL JOS√â AB√çLIO: 2025@</footer>
    </div>
    
    <!-- PAINEL DO PROFESSOR -->
    <div id="admin-area" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex justify-end modal-backdrop">
        <div id="admin-area-content" class="w-full max-w-4xl h-full bg-white shadow-2xl transform translate-x-full">
            <div class="flex flex-col h-full">
                <header class="p-6 border-b flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Painel do Professor</h2>
                        <p id="professor-email" class="text-sm text-slate-500"></p>
                    </div>
                    <div>
                        <button id="admin-close-btn" class="p-2 text-slate-400 hover:text-slate-600 transition"><svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                        <button id="logout-btn" class="ml-2 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition text-sm">Sair</button>
                    </div>
                </header>

                <main class="flex-grow p-6 overflow-y-auto">
                    <nav class="flex border-b mb-6">
                        <button data-panel="provas" class="admin-panel-tab border-b-2 border-blue-600 text-blue-600 py-3 px-4 font-semibold">Gerenciar Provas</button>
                        <button data-panel="gabaritos" class="admin-panel-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-4 font-semibold">Consultar Gabaritos</button>
                    </nav>

                    <!-- Painel de Gerenciamento de Provas -->
                    <div id="admin-panel-provas">
                         <div id="exams-admin-list" class="space-y-4"></div>
                         <p id="no-exams-admin" class="hidden text-center text-slate-500 p-8">Nenhuma prova encontrada para gerenciar.</p>
                    </div>

                    <!-- Painel de Consulta de Gabaritos -->
                    <div id="admin-panel-gabaritos" class="hidden">
                         <div id="results-loader" class="hidden w-full h-full flex flex-col items-center justify-center"><div class="spinner"></div><p class="mt-4 text-sm text-slate-500">Buscando resultados...</p></div>
                         <div id="results-content" class="hidden">
                            <input type="text" id="filter-student" class="w-full mb-4 rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="üîéÔ∏é Buscar por nome, matr√≠cula, s√©rie ou turma...">
                            <button id="download-all-filtered-btn" class="w-full bg-gray-700 text-white font-semibold py-2.5 px-4 mb-6 rounded-lg hover:bg-gray-800 transition text-sm flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed">Baixar Filtrados (.zip)</button>
                            <div id="results-list" class="space-y-3 max-h-[calc(100vh-250px)] overflow-y-auto pr-2"></div>
                            <p id="no-results-message" class="hidden text-center text-slate-500 py-8">Nenhum resultado encontrado.</p>
                         </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <button id="admin-toggle-btn" class="fixed bottom-6 right-6 z-40 h-16 w-16 bg-slate-800 rounded-full shadow-lg text-white flex items-center justify-center hover:bg-slate-900 transition-all active:scale-95 group">
        <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
        <span class="absolute -left-4 top-1/2 -translate-y-1/2 -translate-x-full whitespace-nowrap bg-slate-800 text-white text-xs font-semibold px-3 py-1 rounded-md opacity-0 group-hover:opacity-100 transition-opacity">√Årea do Professor</span>
    </button>
    
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- CONFIGURA√á√ÉO SUPABASE ---
        const SUPABASE_URL = "https://ggqljtbbjavvyvawiwus.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdncWxqdGJiamF2dnl2YXdpd3VzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNzY0MTgsImV4cCI6MjA3MzY1MjQxOH0.PnMwg10Hu_02lytY91JkfyqlDtAUdB_LpgQLOAJKi04";
        const SUPABASE_BUCKET_NAME = "resultados-provas";
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // --- FIM DA CONFIGURA√á√ÉO ---

        const elements = {
            pageLoader: document.getElementById('page-loader'),
            loadingExams: document.getElementById('loading-exams'),
            examPortal: document.getElementById('exam-portal'),
            adminLoginModal: document.getElementById('admin-login-modal'),
            adminLoginModalContent: document.getElementById('admin-login-modal-content'),
            emailInput: document.getElementById('email-input'),
            passwordInput: document.getElementById('password-input'),
            loginSubmitBtn: document.getElementById('login-submit-btn'),
            loginBtnText: document.getElementById('login-btn-text'),
            loginSpinner: document.getElementById('login-spinner'),
            loginError: document.getElementById('login-error'),
            adminLoginCloseBtn: document.getElementById('admin-login-close-btn'),
            adminToggleBtn: document.getElementById('admin-toggle-btn'),
            adminArea: document.getElementById('admin-area'),
            adminAreaContent: document.getElementById('admin-area-content'),
            adminCloseBtn: document.getElementById('admin-close-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            professorEmail: document.getElementById('professor-email'),
            adminPanelTabs: document.querySelectorAll('.admin-panel-tab'),
            resultsLoader: document.getElementById('results-loader'),
            resultsContent: document.getElementById('results-content'),
            resultsList: document.getElementById('results-list'),
            noResultsMessage: document.getElementById('no-results-message'),
            filterStudent: document.getElementById('filter-student'),
            downloadAllFilteredBtn: document.getElementById('download-all-filtered-btn'),
            examsAdminList: document.getElementById('exams-admin-list'),
            noExamsAdmin: document.getElementById('no-exams-admin')
        };

        let examSchedule = [];
        let allFilesCache = [];

        async function fetchExams() {
            const { data, error } = await supabaseClient.from('provas').select('*').order('area', { ascending: true });
            if (error) {
                console.error("Erro ao buscar provas:", error);
                return [];
            }
            
            const groupedByArea = data.reduce((acc, exam) => {
                const { area, id, series, arquivo_html, data_inicio, data_fim, esta_aberta } = exam;
                const areaId = area.toLowerCase().replace(/[^a-z0-9]/g, '');
                
                if (!acc[areaId]) {
                    acc[areaId] = { area: area, id: areaId, exams: [] };
                }
                
                acc[areaId].exams.push({ 
                    id, 
                    series, 
                    file: arquivo_html, 
                    startDate: data_inicio, 
                    endDate: data_fim,
                    isOpen: esta_aberta 
                });
                return acc;
            }, {});

            return Object.values(groupedByArea);
        }

        function renderTabsAndContents() {
            if(examSchedule.length === 0){
                elements.loadingExams.innerHTML = '<p class="text-slate-500">Nenhuma avalia√ß√£o agendada no momento.</p>';
                return;
            }
            elements.loadingExams.classList.add('hidden');
            elements.examPortal.classList.remove('hidden');

            const tabsContainer = document.getElementById('tabs');
            const tabContainer = document.getElementById('tab-container');
            tabsContainer.innerHTML = ''; tabContainer.innerHTML = '';
            examSchedule.forEach((areaData, index) => {
                const isActive = index === 0;
                tabsContainer.innerHTML += `<button class="tab-btn shrink-0 border-b-2 px-1 py-4 text-sm font-medium ${isActive ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700'}" data-tab="${areaData.id}">${areaData.area}</button>`;
                tabContainer.innerHTML += `<div id="${areaData.id}-content" class="${isActive ? '' : 'hidden'} tab-content grid grid-cols-1 md:grid-cols-3 gap-8"></div>`;
            });
            renderExamsForTab(examSchedule[0].id);
            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', handleTabClick));
        }

        function handleTabClick(e) {
            const tabId = e.target.dataset.tab;
            document.querySelectorAll('.tab-btn').forEach(t => { t.classList.remove('border-blue-600', 'text-blue-600'); t.classList.add('border-transparent', 'text-gray-500'); });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            e.target.classList.add('border-blue-600', 'text-blue-600'); e.target.classList.remove('border-transparent', 'text-gray-500');
            const content = document.getElementById(`${tabId}-content`);
            if (content) content.classList.remove('hidden');
            renderExamsForTab(tabId);
        }

        function renderExamsForTab(tabId) {
            const areaData = examSchedule.find(a => a.id === tabId);
            const container = document.getElementById(`${tabId}-content`);
            container.innerHTML = '';
            areaData.exams.forEach((exam, cardIndex) => {
                const now = new Date(); 
                const startDate = new Date(exam.startDate); 
                const endDate = new Date(exam.endDate);
                
                let status = 'available';
                if (!exam.isOpen) status = 'locked';
                else if (now < startDate) status = 'locked';
                else if (now > endDate) status = 'expired';

                const wrapper = document.createElement('div');
                wrapper.className = `exam-card-wrapper ${status}`;
                wrapper.style.animationDelay = `${cardIndex * 100}ms`;

                const card = document.createElement('div');
                card.dataset.exam = JSON.stringify(exam); 
                card.dataset.status = status;
                card.className = `exam-card h-full relative p-8 rounded-2xl shadow-lg border border-slate-200/50 transition-all duration-300 ease-in-out ${status === 'expired' ? 'opacity-50 grayscale cursor-not-allowed' : `cursor-pointer group ${status === 'available' ? 'hover:scale-[1.03] hover:shadow-2xl' : ''}`}`;
                
                const diffDays = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                const statusText = status === 'locked' 
                    ? `<p class="text-xs font-semibold text-amber-600">Dispon√≠vel em ${new Intl.DateTimeFormat('pt-BR', { dateStyle: 'short', timeStyle: 'short' }).format(startDate)}</p>` 
                    : status === 'expired' ? `<p class="text-xs font-semibold text-slate-500">Avalia√ß√£o Encerrada</p>` 
                    : `<p class="text-xs font-semibold text-green-600">Dispon√≠vel para Iniciar</p>`;
                
                card.innerHTML = `<div class="text-center"><div class="flex items-center justify-center w-20 h-20 mx-auto bg-blue-100 rounded-full mb-5 ring-4 ring-white transition-colors group-hover:bg-blue-200"><span class="text-4xl font-bold text-blue-600">${exam.series.replace('¬™ S√©rie', '')}</span><span class="text-lg font-bold mt-2 text-blue-600">¬™</span></div><h2 class="text-2xl font-bold text-slate-800">S√©rie</h2><p class="text-slate-500 mt-2">${areaData.area}</p><div class="mt-4">${statusText}</div></div>`;
                
                wrapper.appendChild(card);
                container.appendChild(wrapper);
            });
            document.querySelectorAll('.exam-card').forEach(c => c.addEventListener('click', handleExamCardClick));
        }

        function handleExamCardClick() {
            const { status, exam } = this.dataset;
            if (status !== 'available') return;
            const examData = JSON.parse(exam);

            if (!examData.file || examData.file === '#') {
                alert("Link da prova ainda n√£o configurado.");
                return;
            }
            elements.pageLoader.classList.remove('hidden');
            setTimeout(() => window.location.href = examData.file, 1500);
        }
        
        async function openAdminPanel() {
            elements.adminArea.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            setTimeout(() => elements.adminAreaContent.classList.remove('translate-x-full'), 10);
            renderAdminExamsList();
        }

        function closeAdminPanel() {
            elements.adminAreaContent.classList.add('translate-x-full');
            setTimeout(() => {
                elements.adminArea.classList.add('hidden');
                document.body.style.overflow = '';
            }, 500);
        }

        // FUN√á√ïES DA √ÅREA DO PROFESSOR (NOVO)

        function renderAdminExamsList() {
            const list = elements.examsAdminList;
            list.innerHTML = '';
            if (examSchedule.length === 0) {
                elements.noExamsAdmin.classList.remove('hidden');
                return;
            }
            elements.noExamsAdmin.classList.add('hidden');

            examSchedule.forEach(area => {
                area.exams.forEach(exam => {
                    const startDate = new Date(exam.startDate).toISOString().slice(0, 16);
                    const endDate = new Date(exam.endDate).toISOString().slice(0, 16);
                    
                    const item = document.createElement('div');
                    item.className = 'bg-slate-50 p-4 rounded-lg border flex flex-col md:flex-row items-start md:items-center gap-4';
                    item.dataset.examId = exam.id;
                    item.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-bold text-slate-800">${area.area} - ${exam.series}</p>
                            <p class="text-sm text-slate-500">${exam.file}</p>
                        </div>
                        <div class="w-full md:w-auto flex flex-col md:flex-row items-stretch md:items-center gap-4">
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium whitespace-nowrap" for="start-${exam.id}">In√≠cio:</label>
                                <input type="datetime-local" id="start-${exam.id}" value="${startDate}" class="exam-date-input border-gray-300 rounded-md shadow-sm text-sm p-2 w-full">
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium" for="end-${exam.id}">Fim:</label>
                                <input type="datetime-local" id="end-${exam.id}" value="${endDate}" class="exam-date-input border-gray-300 rounded-md shadow-sm text-sm p-2 w-full">
                            </div>
                            <button class="exam-status-toggle w-full md:w-auto text-white font-bold py-2 px-4 rounded transition ${exam.isOpen ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}">
                                ${exam.isOpen ? 'Aberta' : 'Fechada'}
                            </button>
                            <button class="update-exam-btn w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded transition flex justify-center items-center h-10">
                               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            });
        }
        
        async function handleExamUpdate(e) {
            const btn = e.target.closest('.update-exam-btn');
            if (!btn) return;
            
            const examItem = btn.closest('[data-exam-id]');
            const examId = examItem.dataset.examId;
            const startDate = examItem.querySelector(`#start-${examId}`).value;
            const endDate = examItem.querySelector(`#end-${examId}`).value;

            // Encontra a prova e o status correspondente
            let examStatus = false;
             examSchedule.forEach(area => {
                const foundExam = area.exams.find(ex => ex.id == examId);
                if (foundExam) examStatus = foundExam.isOpen;
            });

            btn.disabled = true;
            btn.innerHTML = `<div class="spinner" style="width:20px;height:20px;border-left-color:white;"></div>`;

            const { error } = await supabaseClient
                .from('provas')
                .update({ 
                    data_inicio: new Date(startDate).toISOString(), 
                    data_fim: new Date(endDate).toISOString(),
                    esta_aberta: examStatus
                })
                .eq('id', examId);
            
            if (error) {
                console.error("Erro ao atualizar prova:", error);
                alert('Falha ao salvar as altera√ß√µes. Verifique o console.');
                btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
            } else {
                 btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                await reloadAllExams();
            }

            setTimeout(() => { btn.disabled = false; }, 1000);
        }

        async function handleStatusToggle(e) {
             const btn = e.target.closest('.exam-status-toggle');
             if (!btn) return;

             const examItem = btn.closest('[data-exam-id]');
             const examId = examItem.dataset.examId;

             // Encontra e atualiza o estado localmente primeiro para resposta visual imediata
             let updatedIsOpen = false;
             examSchedule.forEach(area => {
                 const exam = area.exams.find(ex => ex.id == examId);
                 if (exam) {
                     exam.isOpen = !exam.isOpen;
                     updatedIsOpen = exam.isOpen;
                 }
             });

            // Atualiza a UI
            btn.textContent = updatedIsOpen ? 'Aberta' : 'Fechada';
            btn.classList.toggle('bg-green-500', updatedIsOpen);
            btn.classList.toggle('hover:bg-green-600', updatedIsOpen);
            btn.classList.toggle('bg-red-500', !updatedIsOpen);
            btn.classList.toggle('hover:bg-red-600', !updatedIsOpen);

            // Simula uma chamada ass√≠ncrona para o bot√£o de salvar, para garantir que o estado seja persistido.
            const updateButton = examItem.querySelector('.update-exam-btn');
            updateButton.click(); // Aciona o salvamento completo
        }

        // --- GABARITOS (C√ìDIGO OTIMIZADO) ---
        async function fetchAllResults() {
          const foundFiles = [];
          async function listRec(path = '') {
            const { data, error } = await supabaseClient.storage.from(SUPABASE_BUCKET_NAME).list(path, { limit: 2000 });
            if (error) { console.error("Erro ao listar storage:", error); return; }
            if (!data || data.length === 0) return;
            for (const item of data) {
              if (item.name === '.emptyFolderPlaceholder') continue;
              const sub = path ? `${path}/${item.name}` : item.name;
              if (!item.name.includes('.')) { await listRec(sub); continue; }
              if (!sub.toLowerCase().endsWith('.pdf')) continue;
              foundFiles.push({ fullPath: sub, fileName: item.name });
            }
          }
          await listRec('');
          return foundFiles.map(file => {
            const parts = file.fullPath.split('/');
            return {
              fullPath: file.fullPath,
              series: parts[0] || '',
              class: (parts[1] || '').replace(/^TURMA[_-]?/i, '').replace(/_/g, ' '),
              studentInfo: (parts[parts.length-1] || '').replace(/\.pdf$/i, ''),
            };
          });
        }
        function renderResultsList(files) {
          elements.resultsList.innerHTML = '';
          elements.noResultsMessage.classList.toggle('hidden', files.length > 0);
          files.forEach(file => {
            const [matricula, ...nomeParts] = file.studentInfo.split('-');
            const nome = nomeParts.length ? nomeParts.join(' ').trim() : file.studentInfo;
            const subtitle = `${file.series.replace(/_/g, ' ')}${file.class ? ' ‚Ä¢ Turma ' + file.class : ''}`;
            elements.resultsList.innerHTML += `
              <div class="bg-slate-50 p-3 rounded-lg flex items-center gap-4 border">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                  <svg class="w-5 h-5 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 00-13.074.003z" /></svg>
                </div>
                <div class="flex-grow min-w-0">
                  <p class="font-semibold text-sm text-slate-800 truncate" title="${nome}">${nome}</p>
                  <p class="text-xs text-slate-500">${subtitle}</p>
                </div>
                <button data-path="${file.fullPath}" class="download-single-btn flex-shrink-0 bg-blue-500 text-white py-2 px-3 rounded-lg hover:bg-blue-600 transition text-sm w-9 h-9 flex items-center justify-center">
                   <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                </button>
              </div>`;
          });
        }
        function applyFilters() {
            const query = elements.filterStudent.value.toLowerCase().trim();
            const filtered = allFilesCache.filter(file => `${file.studentInfo} ${file.series} ${file.class}`.toLowerCase().replace(/_/g, ' ').includes(query));
            renderResultsList(filtered);
        }
        async function downloadAllFiltered() {
            const btn = elements.downloadAllFilteredBtn;
            const filesToDownload = allFilesCache.filter(file => `${file.studentInfo} ${file.series} ${file.class}`.toLowerCase().replace(/_/g, ' ').includes(elements.filterStudent.value.toLowerCase().trim()));
            if (filesToDownload.length === 0) return;
            btn.disabled = true; btn.innerHTML = `<div class="spinner mr-2"></div>Baixando ${filesToDownload.length}...`;
            const zip = new JSZip();
            try {
                const promises = filesToDownload.map(async f => {
                    const { data, error } = await supabaseClient.storage.from(SUPABASE_BUCKET_NAME).download(f.fullPath);
                    if (error) throw new Error(f.fullPath);
                    zip.file(f.fullPath, data);
                });
                await Promise.all(promises);
                saveAs(await zip.generateAsync({type:"blob"}), "Resultados_Filtrados.zip");
            } catch (error) { alert("Erro ao baixar os arquivos."); } 
            finally { btn.disabled = false; btn.innerHTML = `Baixar Filtrados (.zip)`; }
        }

        async function reloadAllExams(){
            examSchedule = await fetchExams();
            renderTabsAndContents();
            if(document.body.style.overflow === 'hidden'){ // se o painel admin est√° aberto
                renderAdminExamsList();
            }
        }
        
        async function setupEventListeners() {
            // -- Login / Autentica√ß√£o
            elements.adminToggleBtn.addEventListener('click', () => {
                 elements.adminLoginModal.classList.remove('hidden');
                 elements.emailInput.focus();
            });
            elements.adminLoginCloseBtn.addEventListener('click', () => elements.adminLoginModal.classList.add('hidden'));
            elements.loginSubmitBtn.addEventListener('click', async () => {
                const email = elements.emailInput.value;
                const password = elements.passwordInput.value;
                elements.loginError.textContent = '';
                elements.loginBtnText.classList.add('hidden');
                elements.loginSpinner.classList.remove('hidden');

                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

                elements.loginBtnText.classList.remove('hidden');
                elements.loginSpinner.classList.add('hidden');

                if (error) {
                    elements.loginError.textContent = 'Email ou senha inv√°lidos.';
                } else {
                    elements.adminLoginModal.classList.add('hidden');
                    elements.professorEmail.textContent = data.user.email;
                    openAdminPanel();
                }
            });
            elements.logoutBtn.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                closeAdminPanel();
            });
            
            // -- Painel Admin
            elements.adminCloseBtn.addEventListener('click', closeAdminPanel);
            elements.adminArea.addEventListener('click', (e) => { if (e.target === elements.adminArea) closeAdminPanel(); });
            elements.adminPanelTabs.forEach(tab => {
                tab.addEventListener('click', async () => {
                    elements.adminPanelTabs.forEach(t => {
                         t.classList.remove('border-blue-600', 'text-blue-600');
                         t.classList.add('border-transparent', 'text-gray-500');
                    });
                    tab.classList.add('border-blue-600', 'text-blue-600');
                    tab.classList.remove('border-transparent', 'text-gray-500');
                    
                    const panel = tab.dataset.panel;
                    document.getElementById('admin-panel-provas').classList.toggle('hidden', panel !== 'provas');
                    document.getElementById('admin-panel-gabaritos').classList.toggle('hidden', panel !== 'gabaritos');
                    
                    if (panel === 'gabaritos' && allFilesCache.length === 0) { // Carrega sob demanda
                        elements.resultsContent.classList.add('hidden');
                        elements.resultsLoader.style.display = 'flex';
                        allFilesCache = await fetchAllResults();
                        renderResultsList(allFilesCache);
                        elements.resultsLoader.style.display = 'none';
                        elements.resultsContent.classList.remove('hidden');
                    }
                });
            });
            
            // Gerenciamento de Provas (Delegated events)
            elements.examsAdminList.addEventListener('click', (e) => {
                handleExamUpdate(e);
                handleStatusToggle(e);
            });

            // -- Gabaritos
            elements.filterStudent.addEventListener('input', applyFilters);
            elements.downloadAllFilteredBtn.addEventListener('click', downloadAllFiltered);
            elements.resultsList.addEventListener('click', async (e) => {
                const btn = e.target.closest('.download-single-btn'); if(!btn) return;
                btn.disabled = true; const originalContent = btn.innerHTML; btn.innerHTML = `<div class="spinner" style="width:20px;height:20px;border-left-color:white;"></div>`;
                const { data, error } = await supabaseClient.storage.from(SUPABASE_BUCKET_NAME).download(btn.dataset.path);
                if (error) { alert("N√£o foi poss√≠vel baixar."); } else { saveAs(data, btn.dataset.path.split('/').pop()); }
                btn.disabled = false; btn.innerHTML = originalContent;
            });
        }
        
        // --- INICIALIZA√á√ÉO ---
        examSchedule = await fetchExams();
        renderTabsAndContents();
        setupEventListeners();
    });
</script>
</body>
</html>
